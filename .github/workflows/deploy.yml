name: Serverless Prod Deployment

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      PYTHON_VERSION: 3.10
      GIT_PYTHON_GIT_EXECUTABLE: /usr/bin/git
      GIT_PYTHON_REFRESH: quiet
      PEX_ROOT: ${{ runner.temp }}/pex
      DAGSTER_CLOUD_API_TOKEN: ${{ secrets.DAGSTER_CLOUD_API_TOKEN }}
      DAGSTER_CLOUD_URL: https://your-dagster-cloud-url

    steps:
      # Checkout code
      - uses: actions/checkout@v3

      # Install Python
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # Ensure git is on PATH
      - name: Add git to PATH
        run: echo "/usr/bin" >> $GITHUB_PATH

      # Install PEX
      - name: Install PEX
        run: pip install --upgrade pip pex

      # Install Dagster + DBT compatible versions into a local wheel cache
      - name: Pre-download dependencies
        run: |
          pip download --dest ${{ runner.temp }}/deps_cache \
            dagster==1.12.14 \
            dagster-dbt==0.28.14 \
            dagster-snowflake==0.28.14 \
            dbt-core==1.6.0 \
            --no-binary :all: \
            --no-deps

      # Build the PEX in isolated mode
      - name: Build Python Executable (PEX)
        run: |
          pex . \
              -r requirements.txt \
              -o dagster-cloud.pex \
              --python-shebang="/usr/bin/env python3" \
              --disable-cache \
              --find-links ${{ runner.temp }}/deps_cache \
              --isolated

      # Deploy the PEX to Dagster Cloud
      - name: Deploy PEX
        run: ./dagster-cloud.pex deploy --deployment prod
