name: Serverless Prod Deployment

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # --- Ensure git is installed and visible to Python ---
      - name: Install Git
        run: sudo apt-get update && sudo apt-get install -y git

      - name: Set GitPython executable
        run: echo "GIT_PYTHON_GIT_EXECUTABLE=$(which git)" >> $GITHUB_ENV

      # Optional: silence GitPython warnings if you don't need git functionality
      - name: Silence GitPython warnings
        run: echo "GIT_PYTHON_REFRESH=quiet" >> $GITHUB_ENV

      # --- Your existing setup and deployment steps ---
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.10

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Deploy Dagster Cloud Python Executable
        uses: dagster-io/dagster-cloud-action@v1.12.14
        with:
          deployment: prod
